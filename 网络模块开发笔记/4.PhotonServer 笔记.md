## PhotonServer 笔记

#### 下载PhotonServer

- Photonengine包括PhotonServer和PhotonCloud

- 在官网找到SDK,选择SERVER下载

   [Photonengine](https://www.photonengine.com/zh-CN/sdks#server-sdkserverserver)

#### 获得许可证

- 找到PRODUCTS\SERVER\PRICING的100CCU,默认是20连接数,扩展到100也是免费的GET A LICENSE

  [许可证链接](https://www.photonengine.com/zh-CN/Server/Pricing)
  
  放在Photon-OnPremise-Server-SDK_v4-0-29-11263\deploy\bin_Win64目录下,重启就可以增加到100个

#### 如何启动

- 在Photon-OnPremise-Server-SDK_v4-0-29-11263\deploy\bin_Win64目录下找到PhotonControl.exe启动

#### 初识PhotonServer.Config

- 目录在deploy\bin_Win64\PhotonServer.config

- Configuration下有LoadBalancing与MMoDemo,说明两个是已经配置好的Server服务可以在应用程序显示出来

  配置内容:

  

  MaxMessageSize 消息最大长度

  DisplayName 应用显示的名字

  

  协议:一般情况下访问网站都是http://+网站,做数据传输一般使用UDP,TCP比如:下载,聊天

  UDPListeners UDP设置,IPAddress 地址,Port 端口号. 优点:传输快,缺点:不稳定

  TCPListeners TCP设置,PolicyFile,InactivityTimeout 规则设置. 优点:稳定,缺点:速度慢

  PolicyFileListeners,WebSocketListeners,都是配置端口号

  

  Runtime,Server内核

  

  Applications:用来配置应用

  ​	Name:部署名字

  ​	BaseDirectory:部署的文件夹,程序生成的dll文件目录

  ​	Assembly:程序所在的命名空间

  ​	Type程序入口主类名

  ​	ForceAutoRestart:是否自动重启

  ​	日志配置...

#### 创建服务器项目

- 在deploy目录下创建自己的项目文件夹,文件夹下创建bin

- C#创建类库,右键属性,找到生成,选择输出路径,选择刚创建的bin,生成一下就会出现dll文件

- 添加引用:在PhotonServer的lib目录下添加

  Photon.SocketServer.dll

  ExitGamesLibs.dll

  PhotonHostRuntimeInterfaces.dll

- 创建入口类

  ```c#
  //所有的Server端 主类都要集成自ApplicationBase
  public class MyGameServer:ApplicationBase
  {
      /// <summary>
      /// 当一个客户端请求连接
      /// 使用PeerBase,表示和一个客户端的连接
      /// </summary>
      /// <param name="initRequest"></param>
      /// <returns></returns>
      protected override PeerBase CreatePeer( InitRequest initRequest )
      {
          return new ClientPeer ();
      }
      /// <summary>
      /// 初始化
      /// </summary>
      protected override void Setup()
      {
      }
      /// <summary>
      /// Server端关闭处理
      /// </summary>
      protected override void TearDown()
      {
      }
  }
  ```

  ```csharp
  public class ClientPeer:Photon.SocketServer.ClientPeer
  {
      public ClientPeer( InitRequest initRequest ) : base (initRequest)
      {
      }
  
      /// <summary>
      /// 处理客户端的请求
      /// </summary>
      /// <param name="operationRequest"></param>
      /// <param name="sendParameters"></param>
      protected override void OnOperationRequest( OperationRequest operationRequest, SendParameters sendParameters )
      {
      }
      /// <summary>
      /// 断开连接
      /// </summary>
      /// <param name="reasonCode"></param>
      /// <param name="reasonDetail"></param>
      protected override void OnDisconnect( DisconnectReason reasonCode, string reasonDetail )
      {
      }
  }
  ```


- 配置日志文件,添加引用目录lib log4net.dll,ExitGames.Logging.Log4Net.dll导入log4net.config,可以在src-server\Mmo\Photon.MmoDemo.Server里找到,复制之后粘贴到项目根目录

- 配置文件要选择始终复制

- 内容:

  value 配置路径名字 "%property{Photon:ApplicationLogPath}\\MyGame.Server.log" />,修改名字

  maximumFileSize 文件大小...

  初始化日志

  ```c#
  private static readonly ILogger log = LogManager.GetCurrentClassLogger ();
  /// <summary>
  /// 初始化
  /// </summary>
  protected override void Setup()
  {
      //配置日志目录
      log4net.GlobalContext.Properties["Photon:ApplicationLogPath"] = Path.Combine( Path.Combine (this.ApplicationRootPath, "bin_Win64"),"log");
  
      //进行日志初始化 Combine路径组合 BinaryPath文件目录
      FileInfo configFileInfo = new FileInfo (Path.Combine( this.BinaryPath, "log4net.config"));
      if (configFileInfo.Exists)//检查文件是否存在
      {
          LogManager.SetLoggerFactory (Log4NetLoggerFactory.Instance);//创建日志工厂 让photon知道
          XmlConfigurator.ConfigureAndWatch (configFileInfo);//让log4net这个插件读取配置文件
      }
      log.Info ("Setup Completed!,初始化成功");//日志打印
  }
  ```

  点击生成,运行PhotonServer MyGame,查看日志会打印Setup Completed!,初始化成功

  修改代码后一定要点击生成,程序集才会起作用

  日志文件介绍

  - PhotonCLR.log 应用配置出现问题看这个
  - Photon-MyGmaeInstance 启动出现异常看这个
  - MyGame.Server.log 开发逻辑出现问题看这个







