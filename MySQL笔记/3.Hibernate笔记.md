## Hibernate笔记

#### 配置:

- 新建一个控制台项目(测试连接数据库)

- 添加NHibernate 引用 与 MySqlData引用(NHibernate 官网下载 dll文件目录:NHibernate\Required_Bins\NHibernate.dll)

- 在这个项目属性把程序集名称与默认命名空间修改一下,待会配置时需要用到. 	程序集代表bin\debug\.exe文件

- 映射文件配置:根目录项目下添加新建项XML 名字:hibernate.cfg.xml 名字固定的(目录一定是程序集同一级目录)

  内容参考文档**Configure NHibernate**内容:

  [文档链接](https://nhibernate.info/doc/tutorials/first-nh-app/your-first-nhibernate-based-application.html )
  
  ```xml
  <?xml version="1.0" encoding="utf-8" ?>
  <hibernate-configuration xmlns="urn:nhibernate-configuration-2.2">
    <session-factory>
      <property name="connection.provider">NHibernate.Connection.DriverConnectionProvider</property>
      <property name="dialect">NHibernate.Dialect.MySQL5Dialect</property>  
        //这里设置MySql版本,我用的MySql8.0,写成5也是可以的,不是很明白
      <property name="connection.driver_class">NHibernate.Driver.MySqlDataDriver</property> 
        //设置连接的数据库,使用什么数据库 MySqlDataDriver MySql大小写不能写错
      <property name="connection.connection_string">Server=localhost;Database=mygamedb;User ID=root; Password=root;</property>
        //配置连接设置,语句后加分号
  
      <property name="show_sql">true</property>
        //控制台显示Sql语句
    </session-factory>
  </hibernate-configuration>
  ```
  
  配置文件设置:复制到输出目录:始终复制
  
  ![image-20210902090916894](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210902090916894.png)
  
- 创建模型类 在根目录创建model文件,在这个文件了添加类,类名与属性一定要与表名对应起来,不容易出错,例如:

```csharp
    public class User
    {
        public virtual int Id { get; set; }
        public virtual string Username { get; set; }
        public virtual string Password { get; set; }
        public virtual DateTime Registerdate { get; set; }

    }
```

![image-20210902084424642](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210902084424642.png)

- 添加映射文件,一个类对应一个映射文件,根目录添加Mappings,Mappings文件下创建XML配置文件,名称保持规范User.hbm.xml

  内容参考文档**The complete mapping file**内容:

  [文档链接](https://nhibernate.info/doc/tutorials/first-nh-app/your-first-nhibernate-based-application.html )

  ```xml
  <?xml version="1.0" encoding="utf-8" ?>
  //版本
  <hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                     //版本
                     assembly="NHibernateTangZe"
                     //程序集名
                     namespace="NHibernateTangZe.Model">
      			  //命名空间
  //映射:
    <class name="User" table="users">
        //类对应表
      <id name="Id" column="id" type="Int32">
          //字段对应列名,类型
        <generator class="native" />
          设置生成器:类型为:本地,本地为自动增长
      </id>
      <property name="Username" column="username" type="String"></property>
        //字段对应列名 type类型为Hibernate类型
      <property name="Password" column="password" type="String"></property>
      <property name="Registerdate" column="registerdate" type="Date" ></property>
    </class>
  </hibernate-mapping>
  ```

  类型参考链接:

  [文档连接](https://nhibernate.info/doc/nhibernate-reference/mapping.html#mapping-types)

  配置命名空间下的这个类与数据库的某个数据相对应,从而进行映射

  配置文件设置:生成操作:嵌入的资源(需要与程序集打包到一起)

  ![image-20210902091108642](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210902091108642.png)

#### 对应模型写功能

- 解析nhibernate.cfg.xml文件

  ```csharp
   var configration = new Configuration ();
              configration.Configure ();//解析nhibernate.cfg.xml文件
              configration.AddAssembly ("NHibernateTangZe");//添加程序集解析映射文件 User.hbm.xml...
  ```

- 添加一条数据

  ```csharp
  ISessionFactory sessionFactory = null;
  ISession session = null;
  ITransaction transaction = null;
  
  try
  {
      sessionFactory = configration.BuildSessionFactory (); //创建绘制工厂
      session = sessionFactory.OpenSession ();//打开一个跟数据库的连接
  
      //User user = new User () { Username = "qingong1",Password = "123" };//增加一条数据
      //session.Save (user);
      //利用事务避免误操作增加或者删除重要数据
      //事务:在事务操作中如果有一条操作失败会导致此事务里的全部操作失效,避免重复在Sql加入多余无意义的数据
      transaction = session.BeginTransaction ();
  
      //操作
      User user1 = new User () { Username = "qingong2", Password = "123" };//增加一条数据
      User user2 = new User () { Username = "qingong4", Password = "123" };//增加一条数据
      session.Save (user1);
      session.Save (user2);
      //操作结束
  
      transaction.Commit ();//提交
  }
  catch (Exception e)
  {
      Console.WriteLine (e);
  }
  finally
  {
      //此顺序尽量不要打乱,因为开启顺序不同,错误的关闭会导致意想不到的错误
      if (transaction != null)
          transaction.Dispose ();
      if (session != null)
          session.Close ();
      if (sessionFactory != null)
          sessionFactory.Close ();
  }
  ```

#### 封装代码

- 创建接口

  ```csharp
    interface IUserManager
      {
          /// <summary>
          /// 增加数据
          /// </summary>
          /// <param name="user"></param>
          void Add( User user );
          /// <summary>
          /// 更改数据
          /// </summary>
          /// <param name="user">主键不能为空</param>
          void Update( User user );
          /// <summary>
          /// 删除数据
          /// </summary>
          /// <param name="user">主键不能为空</param>
          void Remove(User user);
          /// <summary>
          /// 通过主键id得到信息
          /// </summary>
          /// <param name="id"></param>
          /// <returns></returns>
          User GetById(int id);
          /// <summary>
          /// 通过username得到信息,用户名是唯一的
          /// </summary>
          /// <param name="username">用户名</param>
          /// <returns></returns>
          User GetByUsername( string username );
          /// <summary>
          /// 得到所有信息
          /// </summary>
          /// <returns></returns>
          ICollection<User> GetAllUsers();
          /// <summary>
          /// 登录验证
          /// </summary>
          /// <param name="username"></param>
          /// <param name="password"></param>
          /// <returns></returns>
          bool VerifyUser(string username,string password);
      }
  ```


- 简化解析方法

  ```csharp
   class NhibernateHelper
      {
          private static ISessionFactory _sessionFactory;
  
          private static ISessionFactory SessionFactory {
              get
              {
                  if (_sessionFactory==null)
                  {
                      var configration = new Configuration ();
                      configration.Configure ();//解析nhibernate.cfg.xml文件
                      configration.AddAssembly ("NHibernateTangZe");//添加程序集解析映射文件 User.hbm.xml...
                      _sessionFactory = configration.BuildSessionFactory();
                  }
                  return _sessionFactory;
              }
          }
          public static ISession OpenSession()
          {
              return SessionFactory.OpenSession ();
          }
      }
  ```

- 接口实现

  ```csharp
   class UserManager:IUserManager
      {
          public void Add( User user )
          {
              //ISession session = NhibernateHelper.OpenSession ();之前写法 还未释放资源,可想而知代码量会很大
              //session.Save (user);
              //session.Close ();
              
              //使用using写法释放资源,自动释放资源()内的资源
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  using (ITransaction transaction = session.BeginTransaction ())//开启事务
                  {
                      session.Save (user);//增加一条数据
                      transaction.Commit ();//事务提交
                  }
              }
          }
  
          public void Update( User user )
          {
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  using (ITransaction transaction = session.BeginTransaction ())//开启事务
                  {
                      session.Update (user);//更新一条数据,主键不能为null
                      transaction.Commit ();//事务提交
                  }
              }
          }
  
          public void Remove( User user )
          {
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  using (ITransaction transaction = session.BeginTransaction ())//开启事务
                  {
                      session.Delete (user);//删除一条数据,主键不能为null
                      transaction.Commit ();//事务提交
                  }
              }
          }
  
          public User GetById( int id )
          {
              User user = null;
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  using (ITransaction transaction = session.BeginTransaction ())//开启事务
                  {
                      user=session.Get<User> (id);//根据主键得到一条数据
                      transaction.Commit ();//事务提交
                  }
              }
              return user;
          }
  
          public User GetByUsername( string username )
          {
              User user = null;
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  //利用反射查询数据
                  //ICriteria criteria= session.CreateCriteria (typeof(User));//创建一个新的类,类型是User
                  //criteria.Add (Restrictions.Eq("username", username));//第一个""是字段名,添加一个Restrictions.Eq约束想要检索的结果
                  //user= criteria.UniqueResult<User> ();检索
                  
                  //快捷写法
                  user = session.CreateCriteria (typeof (User)).Add (Restrictions.Eq ("Username", username)).UniqueResult<User> ();
              }
              return user;
          }
  
          public ICollection<User> GetAllUsers()
          {
              IList< User> users = null;
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  users = session.CreateCriteria (typeof (User)).List<User> ();//返回一个合集类型是IList<>
              }
              return users;
          }
  
          public bool VerifyUser( string username, string password )
          {
              bool IsLogin = false;
              using (ISession session = NhibernateHelper.OpenSession ())//session数据库连接
              {
                  User user = session.CreateCriteria (typeof (User)).
                      Add (Restrictions.Eq ("Username", username)).//约束得到的结果
                      Add(Restrictions.Eq ("Password", password)).
                      UniqueResult<User> ();//得到值
                  if (user != null)
                      IsLogin = true;
              }
              return IsLogin;
          }
      }
  ```

- 使用方法

  ```csharp
  IUserManager userManager = new UserManager ();//得到对象
  
  User user1 = new User () { Username = "柴", Password = "112345" };//增加数据
  userManager.Add (user1);
  
  User user2 = new User () { Id = 21, Username = "浪费资源", Password = "112345" };//修改数据
  userManager.Update (user2);
  
  User user3 = new User () { Id = 22 };//删除数据
  userManager.Remove (user3);
  
  User user4 = userManager.GetById (25);//通过ID查询数据
  Console.WriteLine (user4.Username + " " + user4.Password);
  
  User user5 = userManager.GetByUsername ("Chai");//通过username查询
  Console.WriteLine (user5.Password);
  
  foreach (User item in userManager.GetAllUsers ())//查询所有
  {
      Console.WriteLine (item.Username + " " + item.Password + " " + item.Registerdate);
  }
  
  Console.WriteLine (userManager.VerifyUser ("Chai", "123"));//登陆验证
  Console.ReadKey ();
  ```

  
